<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>个人中心</title>
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <script type="text/javascript" src="js/jquery-3.4.1.js"></script>

    <script id="navTpl" type="text/html">
        <li><a href="">首页</a></li>
    </script>
</head>
<body class="index">
<div class="ucenter container">
    <div class="header" id="header">
        <h1 class="logo">
            <a title="" style="background: url(images/logo.png);" href="index.html">电子商务平台</a>
        </h1>
        <ul class="shortcut">

        </ul>
    </div>
    <div class="navbar">
        <ul id="goodsType">

        </ul>
        <div class="mycart">
            <dl>
                <dt>
                    <a href="cart.html">购物车<b name="mycart_nums" id="mycart_nums">0</b>件
                    </a>
                </dt>
                <dd>
                    <a href="cart.html">去结算</a>
                </dd>
            </dl>
            <!--购物车浮动div 开始-->
            <div class="shopping" id="div_mycart" style="display: none;">
                <dl class="cartlist" id="shopcarDiv">
                </dl>
            </div>

        </div>
    </div>
    <div class="searchbar">
    </div>
    <div class="wrapper clearfix">
        <div class="sidebar f_l">
            <img src="images/front/ucenter/ucenter.gif" width="180" height="40">
            <div class="box">
                <div class="title">
                    <h2>交易记录</h2>
                </div>
                <div class="cont">
                    <ul class="list">
                        <li><a href="myOrders.html" class="menu">我的订单</a></li>
                    </ul>
                </div>
            </div>
            <div class="box">
                <div class="title">
                    <h2 class="bg5">个人设置</h2>
                </div>
                <div class="cont">
                    <ul class="list">
                        <li><a href="address.html" class="menu">地址管理</a></li>
                    </ul>
                    <ul class="list">
                        <li><a href="headPortrait.html" class="menu">修改头像</a></li>
                    </ul>
                    <ul class="list">
                        <li><a href="modifyPassword.html" class="menu">修改密码</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="main f_r" id="main">
            <div class="tabs">
                <div class="uc_title m_10 tabs_menu">
                    <label class="current node"><span>地址管理</span></label>
                </div>
                <div class="tabs_content">
                    <div id="address_list" class="form_content m_10 node">
                        <div class="uc_title2 m_10">
                            <strong>已保存的有效地址</strong>
                            <a href="#" id="addNewAddress" style="color: #4b63a7">新增收货地址</a>
                        </div>
                        <table class="list_table" width="100%" cellpadding="0" cellspacing="0">
                            <colgroup>
                                <col width="120px">
                                <col width="120px">
                                <col width="240px">
                                <col width="120px">
                                <col width="150px">
                                <col>
                            </colgroup>
                            <thead>
                            <tr>
                                <th>收货人</th>
                                <th>所在地区</th>
                                <th>街道地址</th>
                                <th>手机</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody id="addressdata">

                            </tbody>
                        </table>
                    </div>
                </div>
                <!--表单修改-->
                <div class="orange_box" id="address_form">
                    <input type="hidden" id="id" value="">
                    <table class="form_table" width="100%" cellpadding="0" cellspacing="0">
                        <colgroup>
                            <col width="120px">
                            <col>
                        </colgroup>
                        <caption>收货地址</caption>
                        <tbody id="addOrEdit">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="help m_10">
        <div class="cont clearfix">
            <dl>
                <dt>
                    <a href="">购物指南</a>
                </dt>
                <dd>
                    <a href="">订单状态</a>
                </dd>
                <dd>
                    <a href="">购物流程</a>
                </dd>
            </dl>
            <dl>
                <dt>
                    <a href="">支付帮助</a>
                </dt>
                <dd>
                    <a href="">支付帮助</a>
                </dd>
                <dd>
                    <a href="">在线支付</a>
                </dd>
                <dd>
                    <a href="">货到付款</a>
                </dd>
            </dl>
            <dl>
                <dt>
                    <a href="">配送帮助</a>
                </dt>
                <dd>
                    <a href="">EMS/邮政普包</a>
                </dd>
                <dd>
                    <a href="">商品验货与签收</a>
                </dd>
                <dd>
                    <a href="">配送范围及运费</a>
                </dd>
            </dl>
            <dl>
                <dt>
                    <a href="">售后服务</a>
                </dt>
                <dd>
                    <a href="">售后服务</a>
                </dd>
                <dd>
                    <a href="">发票制度</a>
                </dd>
                <dd>
                    <a href="">退货说明</a>
                </dd>
                <dd>
                    <a href="">换货说明</a>
                </dd>
            </dl>
            <dl>
                <dt>
                    <a href="">帮助信息</a>
                </dt>
                <dd>
                    <a href="">友情链接</a>
                </dd>
                <dd>
                    <a href="">联系客服</a>
                </dd>
                <dd>
                    <a href="">找回密码</a>
                </dd>
                <dd>
                    <a href="">关于我们</a>
                </dd>
            </dl>
        </div>
    </div>
    <div class="footer">
        <p class="links">
            <a href="">关于我们</a>|<a href="">常见问题</a>|<a href="">安全交易</a>|<a href="">购买流程</a>|<a href="">如何付款</a>|<a
                href="">联系我们</a>|<a href="">合作提案</a>
        </p>
        Copyright © 2015-2021 <a class="copyys" target="_blank" href="">蜀ICP备01000010号</a>
    </div>
</div>
<script src="js/jquery-3.6.0.js"></script>
<script>
    function exitOut() {
        sessionStorage.setItem("mallUser", null);
    }

    $(function () {
            //获取User
            let mallUser = JSON.parse(sessionStorage.getItem("mallUser"));
            if (mallUser == null || !mallUser) {
                location.href = "login.html"
                return;
            }
            let loginContent = ""
            if (mallUser && mallUser != null) {
                loginContent = "<li className=\"first\"><a href=\"personal.html\">个人中心</a></li>\n" +
                    "        <li><a href=\"myOrders.html\">我的订单</a></li>" +
                    "<li><a href=\"#\">用户名：" + mallUser.account + "</a></li>" +
                    "<li><a href=\"index.html\" onclick='exitOut()'>退出</a></li>";
                var userid = mallUser.id;
                showAddress();

                //展示收货地址
                function showAddress() {
                    $.post("personal.do?method=displayAddress&userid=" + userid, function (message) {
                        let addressList = message.data;
                        let addressContent = "";
                        for (let i = 0; i < addressList.length; i++) {
                            addressContent += "<tr><td>" + addressList[i].accept + "</td>" +
                                "<td>" + addressList[i].province + addressList[i].city + addressList[i].area + "</td>" +
                                "<td>" + addressList[i].address + "</td>" +
                                "<td>" + addressList[i].telphone + "</td>" +
                                "<td><a class=\"blue\" href=\"javascript:void(0)\" value=" + addressList[i].id + " >修改</a>" +
                                "  <a class=\"blue\" href=\"javascript:void(0)\" value=" + addressList[i].id + " >删除</a>  " +
                                (addressList[i].type == "y" ? "| 默认地址" : "") +
                                "</td>" + "</tr>";
                        }
                        $("#addressdata").html(addressContent);
                    }, "json");
                }

                //展示购物车数量
                $.post("cart.do?method=getCartByUserId&userid=" + userid, function (message) {
                    let cartList = message.data;
                    $("#mycart_nums").text(cartList.length);
                }, "json")
            } else {
                loginContent = "<p className=\"loginfo\">[<a href=\"login.html\">登录</a> " +
                    "<a className=\"reg\" href=\"register.html\">免费注册</a>]</p>";
            }
            $(".shortcut").html(loginContent);
            //购物车点击事件监听
            $("div").on("click", $(".mycart"), function (e) {
                if (!mallUser || mallUser == null) {
                    e.preventDefault();
                    location.href = "login.html";
                }
            });
            //地址新增事件监听
            $(".tabs").click(function (e) {
                if ($(e.target).text() == "新增收货地址") {
                    e.preventDefault();
                    //显示
                    let address = null;
                    displayAddOrEditBar(address);
                } else if ($(e.target).val() == "取消") {
                    $("#addOrEdit").html("");
                } else if ($(e.target).val() == "保存") {
                    //获取信息
                    let data = {
                        "accept": $("#accept").val(),
                        "telphone": $("#telphone").val(),
                        "province": $("#province").find("option:selected").text(),
                        "city": $("#city").find("option:selected").text(),
                        "area": $("#area").find("option:selected").text(),
                        "address": $("#address").val(),
                        "type": ($("#type").prop("checked") ? "y" : "n")
                    }
                    if ($(e.target).attr("addressId")) {
                        let addressId = $(e.target).attr("addressId");
                        $.post("personal.do?method=updateAddress&addressId=" + addressId + "&userid=" + userid, data, function (message) {
                            if (message.result == "true") {
                                alert("修改成功！");
                                showAddress();
                                $("#addOrEdit").html("");
                            } else {
                                alert("网络异常，请稍后再试！")
                            }
                        }, "json");
                    } else {
                        $.post("personal.do?method=addAddress&userid=" + userid, data, function (message) {
                            if (message.result == "true") {
                                alert("添加成功！");
                                showAddress();
                                $("#addOrEdit").html("");
                            } else {
                                alert("网络异常，请稍后再试！")
                            }
                        }, "json");
                    }
                } else if ($(e.target).text() == "修改") {
                    let addressId = $(e.target).attr("value");
                    $.post("personal.do?method=displayAddressById&addressId=" + addressId, function (message) {
                        let address = message.data;
                        displayAddOrEditBar(address);
                        $("#save").attr("addressId", addressId);
                    });
                } else if ($(e.target).text() == "删除") {
                    if (confirm("确认删除？")) {
                        let addressId = $(e.target).attr("value");
                        $.post("personal.do?method=deleteAddress&addressId=" + addressId, function (message) {
                            if (message.result == "true") {
                                alert("删除成功！");
                                showAddress();
                            } else {
                                alert("网络异常，请稍后再试！")
                            }
                        })
                    }
                }
            });

            //显示地址新增修改栏
            function displayAddOrEditBar(address) {
                let addContent = `
                    <tr>
                        <th><span class="red">*</span> 收货人姓名：</th>
                        <td><input id="accept" class="normal" type="text" value=` + (address == null ? "" : address.accept) + `><label>收货人真实姓名，方便快递公司联系。</label></td>
                    </tr>
                    <tr>
                        <th><span class="red">*</span> 所在地区：</th>
                        <td><select name="province" id="province">
                        <option >省份</option>
                        </select>
                         <select name="city" id="city">
                        <option >城市</option>
                        </select>
                        <select name="area" id="area">
                        <option >区域</option>
                        </select>
                        </td>
                        </tr>
                        <tr>
                        <th><span class="red">*</span> 街道地址：</th>
                        <td><input name="address" id="address" class="normal"
                                   type="text" value=` + (address == null ? "" : address.address) + `><label>真实详细收货地址，方便快递公司联系。</label></td>
                    </tr>
                    <tr>
                        <th>手机号码：</th>
                        <td><input name="telphone" id="telphone" class="normal"
                                   type="text" value=` + (address == null ? "" : address.telphone) + `><label>手机号码，如：13588888888</label></td>
                    </tr>
                    <tr>
                        <th>设为默认：</th>
                        <td><label><input name="type" id="type" type="checkbox" ` + (address == null ? "" : (address.type == "y" ? "checked" : "")) + `></label></td>
                    </tr>
                    <tr>
                        <th></th>
                        <td><label class="btn"><input type="button" id="save" value="保存"></label> <label
                                class="btn"><input type="button" id="cancel" value="取消"></label></td>
                    </tr>`;
                $("#addOrEdit").html(addContent);
                //省份渲染
                $.ajax({
                    url: "personal.do?method=displayAllProvinces",
                    async: false,
                    dataType: "json",
                    success: function (message) {
                        let content = "<option selected>省份</option>";
                        let provinces = message.data;
                        for (let i = 0; i < provinces.length; i++) {
                            content += "<option value=" + provinces[i].id + ">" + provinces[i].name + "</option>";
                        }
                        $("#province").html(content);
                    }
                });
                $("#province").on("change", function (e) {
                    $.ajax({
                        url: "personal.do?method=displayAllCities&provinceId=" + $("#province").prop("value"),
                        async: false,
                        dataType: "json",
                        success: function (message) {
                            let cities = message.data;
                            let content = "<option selected>城市</option>";
                            for (let i = 0; i < cities.length; i++) {
                                content += "<option value=" + cities[i].id + ">" + cities[i].name + "</option>";
                            }
                            $("#city").html(content);
                        }
                    });
                })
                $("#city").on("change", function (e) {
                    $.ajax({
                        url: "personal.do?method=displayAllAreas&cityId=" + $("#city").prop("value"),
                        async: false,
                        dataType: "json",
                        success: function (message) {
                            let areas = message.data;
                            let content = "<option selected>区域</option>";
                            for (let i = 0; i < areas.length; i++) {
                                content += "<option value=" + areas[i].id + ">" + areas[i].name + "</option>";
                            }
                            $("#area").html(content);
                        }
                    });
                })
            }

        }
    )
</script>
</body>
</html>